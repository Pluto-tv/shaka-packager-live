# Copyright 2023 Pluto TV
# Copyright 2022 Google LLC
#
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file or at
# https://developers.google.com/open-source/licenses/bsd

name: GitHub Nightly Build

on:
  push:
    branches: [ feature/TRANS-4831-nighty-builds ]
  workflow_dispatch:

env:
  DEVELOPMENT_BRANCH: "pluto-cmake"

jobs:
  draft_release:
    name: Create GitHub Nightly draft release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.draft_release.outputs.id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ env.DEVELOPMENT_BRANCH }}

      - name: Draft release
        id: draft_release
        uses: ncipollo/release-action@v1.13.0
        env:
          GITHUB_TOKEN: ${{ secrets.BUILD_TOKEN_EPHEMERAL}}
        with:
          name: "Nightly Build"
          draft: true
          body: "Latest build of the development branch"

  lint:
    name: Lint
    uses: ./.github/workflows/lint.yaml
    with:
      ref: "pluto-cmake"

  build_and_test:
    needs: [lint, draft_release]
    name: Build and test
    uses: ./.github/workflows/build.yaml
    with:
      ref: "pluto-cmake"
